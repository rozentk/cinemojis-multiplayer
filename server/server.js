const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const path = require('path');

const app = express();
const server = http.createServer(app);
const io = socketIo(server);

// ‚úÖ CORRE√á√ÉO: Servir arquivos est√°ticos do diret√≥rio public
app.use(express.static(path.join(__dirname, '../public')));

// ‚úÖ CORRE√á√ÉO: Rota para servir o index.html
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, '../public/index.html'));
});

// üé¨ BASE DE DADOS EXPANDIDA - 20 FILMES
const moviesDatabase = [
    {
        title: "Titanic",
        variations: {
            easy: "üö¢üßäüåä‚ù§Ô∏è",
            medium: "üë©‚Äç‚ù§Ô∏è‚Äçüë®üé®üíéüé∂", 
            hard: "üíÉüö™üõü‚úçÔ∏è"
        },
        acceptedAnswers: ["titanic", "o titanic"]
    },
    {
        title: "O Rei Le√£o",
        variations: {
            easy: "ü¶ÅüëëüåÖüêó",
            medium: "üë®‚Äçüë¶üí´üåüüòà",
            hard: "üêíüåßÔ∏èü¶åüî•"
        },
        acceptedAnswers: ["rei leao", "o rei leao", "the lion king", "rei le√£o", "o rei le√£o"]
    },
    {
        title: "Avatar",
        variations: {
            easy: "üîµüåéüêâüëΩ",
            medium: "üëΩüåøüé®üêé",
            hard: "üíéüöÄüåøüîµ"
        },
        acceptedAnswers: ["avatar"]
    },
    {
        title: "Harry Potter",
        variations: {
            easy: "üë¶‚ö°üßô‚Äç‚ôÇÔ∏èü¶â",
            medium: "‚ö°üßô‚Äç‚ôÇÔ∏èüè∞üêç",
            hard: "üíÄüìúüî•‚ö°"
        },
        acceptedAnswers: ["harry potter"]
    },
    {
        title: "Matrix",
        variations: {
            easy: "üï∂Ô∏èüíäüíªüî¥",
            medium: "üíªüî¥üíäüêá",
            hard: "üåêüíäüî¥üë®‚Äçüíº"
        },
        acceptedAnswers: ["matrix"]
    },
    {
        title: "Star Wars",
        variations: {
            easy: "‚≠ê‚öîÔ∏èüëΩüåå",
            medium: "üöÄüåå‚öîÔ∏èü§ñ",
            hard: "üí´üè∞‚öîÔ∏èüëÅÔ∏è"
        },
        acceptedAnswers: ["star wars", "guerra nas estrelas"]
    },
    {
        title: "Jurassic Park",
        variations: {
            easy: "ü¶ñüå¥üöôüî¨",
            medium: "üêäüîçüèûÔ∏èü•ö",
            hard: "üß¨üî¨üåãüöÅ"
        },
        acceptedAnswers: ["jurassic park", "parque dos dinossauros", "parque jurassico"]
    },
    {
        title: "Toy Story",
        variations: {
            easy: "ü§†‚öîÔ∏èüß∏üöÄ",
            medium: "üéØüìûüçïüöñ",
            hard: "üë∂üééüåûüé™"
        },
        acceptedAnswers: ["toy story"]
    },
    {
        title: "Frozen",
        variations: {
            easy: "üë∏‚ùÑÔ∏è‚òÉÔ∏è‚ù§Ô∏è",
            medium: "üè∞üå®Ô∏èüîÆ‚õÑ",
            hard: "üíéüëëüéµüåä"
        },
        acceptedAnswers: ["frozen", "frozen uma aventura congelante", "congelante"]
    },
    {
        title: "Homem-Aranha",
        variations: {
            easy: "üï∑Ô∏èüë¶üóΩüï∏Ô∏è",
            medium: "üî¥üîµüèôÔ∏èüë®‚Äçüî¨",
            hard: "üí•üöáüé≠üì∑"
        },
        acceptedAnswers: ["homem aranha", "spiderman", "spider-man"]
    },
    {
        title: "Batman",
        variations: {
            easy: "ü¶áüë¶üíºüåÉ",
            medium: "üöóüÉèüî¶üè¢",
            hard: "üé≠üíÄüåÄüîç"
        },
        acceptedAnswers: ["batman", "the batman", "cavaleiro das trevas"]
    },
    {
        title: "Super Mario Bros",
        variations: {
            easy: "üë®üßíüçÑüåü",
            medium: "üê¢üè∞üë∏ü•ö",
            hard: "üî®üê≤üéÆüëë"
        },
        acceptedAnswers: ["super mario", "mario bros", "super mario bros"]
    },
    {
        title: "Vingadores",
        variations: {
            easy: "ü¶∏‚Äç‚ôÇÔ∏èü¶∏‚Äç‚ôÄÔ∏èüíéüëä",
            medium: "üöÄüõ°Ô∏è‚ö°üåé",
            hard: "üß§‚ôæÔ∏è‚öîÔ∏èüë®‚Äçüî¨"
        },
        acceptedAnswers: ["vingadores", "avengers", "os vingadores"]
    },
    {
        title: "O Poderoso Chef√£o",
        variations: {
            easy: "üë®üíºüî´üçä",
            medium: "üé≠üê¥üõåüíµ",
            hard: "‚öñÔ∏èüî™üéªüçù"
        },
        acceptedAnswers: ["o poderoso chefa", "the godfather", "poderoso chefa"]
    },
    {
        title: "De Volta para o Futuro",
        variations: {
            easy: "üöó‚è∞‚ö°üîÆ",
            medium: "üë®‚Äçüë¶üïêüöÄüé∏",
            hard: "üìº‚ö°üß™üëµ"
        },
        acceptedAnswers: ["de volta para o futuro", "back to the future"]
    },
    {
        title: "Senhor dos An√©is",
        variations: {
            easy: "üíçüßô‚Äç‚ôÇÔ∏èüßù‚Äç‚ôÇÔ∏è‚öîÔ∏è",
            medium: "üèîÔ∏èüëÅÔ∏èüî•üßù‚Äç‚ôÄÔ∏è",
            hard: "üßåüó°Ô∏èüåÑüîÆ"
        },
        acceptedAnswers: ["senhor dos aneis", "senhor dos an√©is", "lord of the rings"]
    },
    {
        title: "Pantera Negra",
        variations: {
            easy: "üêÜüëëüíúüåç",
            medium: "üõ∏üíéü§¥üî¨",
            hard: "üí•üå∏‚öîÔ∏èüë∏"
        },
        acceptedAnswers: ["pantera negra", "black panther"]
    },
    {
        title: "Coringa",
        variations: {
            easy: "üÉèü§°üíÑüö¨",
            medium: "üé≠üì∫üî´üèôÔ∏è",
            hard: "üíÉüé™üî®üòÑ"
        },
        acceptedAnswers: ["coringa", "joker"]
    },
    {
        title: "Interestelar",
        variations: {
            easy: "üöÄüååüïêüë®‚Äçüëß",
            medium: "üåΩüï≥Ô∏èüìöüë®‚Äçüî¨",
            hard: "‚è∞üîÑüì°üåë"
        },
        acceptedAnswers: ["interestelar", "interstellar"]
    },
    {
        title: "Os Incr√≠veis",
        variations: {
            easy: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ü¶∏‚Äç‚ôÇÔ∏èüí•ü§ñ",
            medium: "üöÄüëóüåäüë∂",
            hard: "üèùÔ∏è‚öîÔ∏èüß≠üîß"
        },
        acceptedAnswers: ["os incriveis", "the incredibles", "increveis"]
    }
];

// Fun√ß√£o para normalizar texto
function normalizeText(text) {
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s]/g, '')
        .trim();
}

// Sistema de salas
const rooms = {};

function generateRoomCode() {
    return Math.random().toString(36).substring(2, 6).toUpperCase();
}

function createRoom(hostName, difficulty) {
    const roomCode = generateRoomCode();
    
    rooms[roomCode] = {
        host: hostName,
        players: {},
        difficulty: difficulty,
        gameState: 'waiting',
        currentRound: 0,
        totalRounds: 3,
        currentMovie: null,
        timer: null,
        hasRoundEnded: false,
        playersAnswered: new Set()
    };
    
    return roomCode;
}

function startRound(roomCode) {
    const room = rooms[roomCode];
    if (!room) return;
    
    room.currentRound++;
    room.hasRoundEnded = false;
    room.playersAnswered.clear();
    
    const randomMovie = moviesDatabase[Math.floor(Math.random() * moviesDatabase.length)];
    room.currentMovie = {
        ...randomMovie,
        currentEmojis: randomMovie.variations[room.difficulty]
    };
    
    console.log(`Sala ${roomCode} - Rodada ${room.currentRound} iniciada: ${randomMovie.title}`);
    
    io.to(roomCode).emit('startRound', {
        roundNumber: room.currentRound,
        movie: room.currentMovie,
        totalRounds: room.totalRounds
    });
    
    room.timer = setTimeout(() => {
        if (!room.hasRoundEnded) {
            endRound(roomCode);
        }
    }, 15000);
}

function endRound(roomCode) {
    const room = rooms[roomCode];
    if (!room || room.hasRoundEnded) return;
    
    room.hasRoundEnded = true;
    clearTimeout(room.timer);
    
    console.log(`Sala ${roomCode} - Rodada ${room.currentRound} finalizada`);
    
    io.to(roomCode).emit('roundEnd', {
        roundNumber: room.currentRound
    });
    
    if (room.currentRound >= room.totalRounds) {
        setTimeout(() => endGame(roomCode), 3000);
    } else {
        setTimeout(() => startRound(roomCode), 3000);
    }
}

function endGame(roomCode) {
    const room = rooms[roomCode];
    if (!room) return;
    
    room.gameState = 'ended';
    
    const players = Object.values(room.players);
    const winner = players.reduce((prev, current) => 
        (prev.score > current.score) ? prev : current
    );
    
    io.to(roomCode).emit('gameEnd', {
        players: players,
        winner: winner
    });
    
    console.log(`Sala ${roomCode} - Jogo finalizado. Vencedor: ${winner.name}`);
}

// Conex√µes Socket.io
io.on('connection', (socket) => {
    console.log('Usu√°rio conectado:', socket.id);

    socket.on('createRoom', (data) => {
        const roomCode = createRoom(data.playerName, data.difficulty);
        socket.join(roomCode);
        
        rooms[roomCode].players[socket.id] = {
            id: socket.id,
            name: data.playerName,
            score: 0,
            isHost: true
        };
        
        socket.emit('roomCreated', { roomCode: roomCode });
        io.to(roomCode).emit('playersUpdate', { 
            players: Object.values(rooms[roomCode].players) 
        });
        
        console.log(`Sala criada: ${roomCode} por ${data.playerName}`);
    });

    socket.on('joinRoom', (data) => {
        const room = rooms[data.roomCode];
        
        if (!room) {
            socket.emit('error', { message: 'Sala n√£o encontrada!' });
            return;
        }
        
        if (room.gameState !== 'waiting') {
            socket.emit('error', { message: 'Jogo j√° em andamento!' });
            return;
        }
        
        socket.join(data.roomCode);
        
        room.players[socket.id] = {
            id: socket.id,
            name: data.playerName,
            score: 0,
            isHost: false
        };
        
        socket.emit('roomJoined', { roomCode: data.roomCode });
        io.to(data.roomCode).emit('playersUpdate', { 
            players: Object.values(room.players) 
        });
        
        console.log(`Jogador ${data.playerName} entrou na sala ${data.roomCode}`);
    });

    socket.on('startGame', (roomCode) => {
        const room = rooms[roomCode];
        if (room && room.players[socket.id]?.isHost) {
            room.gameState = 'playing';
            io.to(roomCode).emit('gameStarted');
            startRound(roomCode);
        }
    });

    socket.on('submitAnswer', (data) => {
        const room = rooms[data.roomCode];
        if (!room || room.hasRoundEnded) return;
        
        const player = room.players[socket.id];
        if (!player || room.playersAnswered.has(socket.id)) return;
        
        const normalizedAnswer = normalizeText(data.answer);
        const isCorrect = room.currentMovie.acceptedAnswers.some(answer => 
            normalizeText(answer) === normalizedAnswer
        );
        
        if (isCorrect) {
            room.playersAnswered.add(socket.id);
            
            const timeLeft = 15000 - (Date.now() - data.timestamp);
            const points = Math.max(100, Math.floor(timeLeft / 150));
            
            player.score += points;
            
            socket.emit('answerResult', { 
                correct: true, 
                points: points,
                movieTitle: room.currentMovie.title
            });
            
            io.to(data.roomCode).emit('playersUpdate', { 
                players: Object.values(room.players) 
            });
            
            console.log(`Jogador ${player.name} acertou! +${points} pontos`);
            
            if (room.playersAnswered.size >= Object.keys(room.players).length) {
                setTimeout(() => endRound(data.roomCode), 1000);
            }
        } else {
            socket.emit('answerResult', { 
                correct: false 
            });
        }
    });

    socket.on('disconnect', () => {
        console.log('Usu√°rio desconectado:', socket.id);
        
        for (const roomCode in rooms) {
            if (rooms[roomCode].players[socket.id]) {
                delete rooms[roomCode].players[socket.id];
                io.to(roomCode).emit('playersUpdate', { 
                    players: Object.values(rooms[roomCode].players) 
                });
                
                if (rooms[roomCode].players[socket.id]?.isHost) {
                    io.to(roomCode).emit('hostLeft');
                    delete rooms[roomCode];
                }
            }
        }
    });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, '0.0.0.0', () => {
    console.log(`üéÆ Servidor rodando na porta ${PORT}`);
    console.log(`üåê Acesse: http://localhost:${PORT}`);
    console.log(`üé¨ Base de dados: ${moviesDatabase.length} filmes carregados`);
});